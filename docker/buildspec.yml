version: 0.2

env:
  variables:
    AWS_DEFAULT_REGION: eu-north-1
    ECR_REPO: 085494094875.dkr.ecr.eu-north-1.amazonaws.com/docker-registry
    PROJECT_DIR: docker   # â† was docker/docker

phases:
  install:
    commands:
      - echo "Using CodeBuild standard image Docker & Maven (if present)"
      - mvn -v || true

  pre_build:
    commands:
      - echo "Logging in to Amazon ECR..."
      - aws ecr get-login-password --region "$AWS_DEFAULT_REGION" | docker login --username AWS --password-stdin "$ECR_REPO"
      - COMMIT_SHA=$(echo "$CODEBUILD_RESOLVED_SOURCE_VERSION" | cut -c1-7 || true)
      - IMAGE_TAG=${COMMIT_SHA:-latest}
      - echo "IMAGE_TAG=$IMAGE_TAG"

  build:
    commands:
      - echo "Building JAR"
      - cd "$PROJECT_DIR"
      - ls -la
      - test -f pom.xml
      - mvn -q -DskipTests clean package
      - echo "Building Docker image"
      - docker build -t "$ECR_REPO:$IMAGE_TAG" .
      - docker tag "$ECR_REPO:$IMAGE_TAG" "$ECR_REPO:latest"

  post_build:
    commands:
      - echo "Pushing images"
      - docker push "$ECR_REPO:$IMAGE_TAG"
      - docker push "$ECR_REPO:latest"
      - printf '[{"name":"app","imageUri":"%s"}]' "$ECR_REPO:$IMAGE_TAG" > imagedefinitions.json
artifacts:
  files:
    - docker/target/*.jar
    - imagedefinitions.json
