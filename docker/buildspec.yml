version: 0.2

env:
  variables:
    AWS_DEFAULT_REGION: eu-north-1
    # ECR repo URI (no tag)
    ECR_REPO: 085494094875.dkr.ecr.eu-north-1.amazonaws.com/docker-registry
    # folder that contains your pom.xml, Dockerfile, etc.
    PROJECT_DIR: docker
    # MUST match the container name in your ECS task definition
    CONTAINER_NAME: docker-registry

phases:
  install:
    commands:
      - set -euo pipefail
      - echo "Using CodeBuild standard image; docker + maven should be available"
      - mvn -v || true

  pre_build:
    commands:
      - echo "Logging in to Amazon ECR..."
      - aws ecr get-login-password --region "$AWS_DEFAULT_REGION" | docker login --username AWS --password-stdin "$ECR_REPO"
      - COMMIT_SHA=$(echo "${CODEBUILD_RESOLVED_SOURCE_VERSION:-}" | cut -c1-7 || true)
      - IMAGE_TAG=${COMMIT_SHA:-latest}
      - echo "IMAGE_TAG=$IMAGE_TAG"

  build:
    commands:
      - echo "Building application JAR..."
      - cd "$PROJECT_DIR"
      - ls -la
      - test -f pom.xml
      - mvn -q -DskipTests clean package
      - echo "Building Docker image..."
      - docker build -t "$ECR_REPO:$IMAGE_TAG" .
      - docker tag  "$ECR_REPO:$IMAGE_TAG" "$ECR_REPO:latest"

  post_build:
    commands:
      - echo "Pushing images to ECR..."
      - docker push "$ECR_REPO:$IMAGE_TAG"
      - docker push "$ECR_REPO:latest"
      # return to the source root so imagedefinitions.json lands at the artifact root
      - cd "$CODEBUILD_SRC_DIR"
      - printf '[{"name":"%s","imageUri":"%s"}]' "$CONTAINER_NAME" "$ECR_REPO:$IMAGE_TAG" > imagedefinitions.json
      - echo "Generated imagedefinitions.json:"
      - cat imagedefinitions.json

artifacts:
  files:
    - imagedefinitions.json
    # optional: publish the built jar if you want it as an artifact too
    - docker/target/*.jar
